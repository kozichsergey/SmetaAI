# SELF_GUIDE.md - Полное руководство по системе SmetaAI

## 1. Общая философия и принципы разработки

### **Принцип "Не навреди" (Стабильность превыше всего)**
Главная цель — итеративно улучшать систему, не ломая то, что уже работает. Любое изменение должно вноситься с оглядкой на существующий код. Прежде чем что-то добавить, я должен убедиться, что не нарушаю зависимости и логику в других частях системы.

### **Принцип "Семь раз отмерь" (Никаких догадок)**
Я не должен делать предположений о том, как работает тот или иной модуль. Если я не знаю точное имя метода или его сигнатуру, мой первый шаг — прочитать соответствующий файл (`read_file`). Я не должен придумывать имена методов или предполагать наличие импортов.

### **Принцип "Проверяй сделанное" (Тестирование после каждого шага)**
После каждого значимого изменения (правка файла, добавление функции), особенно в бэкенд-логике, я должен немедленно проверить работоспособность. Для веб-сервера это означает перезапуск и тестовый запрос (`curl`), а не слепую веру в то, что все заработает.

### **Принцип "Стабильная версия" (Сохранение рабочих состояний)**
При достижении стабильной работы всех компонентов (например, успешное распознавание всех документов), необходимо обновить SELF_GUIDE.md и зафиксировать текущее состояние как эталонное.

## 2. Архитектура системы SmetaAI

### **Общее описание**
Система "SmetaAI" — это веб-приложение на Flask, предназначенное для автоматизации обработки строительных смет с использованием AI. Основана на OpenAI Assistants API с Code Interpreter для максимально точного извлечения данных из Excel-документов.

### **Ключевые технологии**
- **Backend**: Flask (Python)
- **AI**: OpenAI Assistants API + Code Interpreter
- **Frontend**: HTML + JavaScript + Bootstrap
- **Data**: JSON для хранения, Excel для ввода/вывода
- **Processing**: pandas (через AI Code Interpreter)

### **Статус системы (последнее обновление)**
✅ **СТАБИЛЬНАЯ ВЕРСИЯ** - все 3 документа успешно распознаются
- Исправлены все критические ошибки
- Работает логика отмены задач
- Корректно обрабатываются rate limits
- UI полностью функционален

## 3. Структура файлов и модулей

### **Основные компоненты приложения**

#### **`app.py`** - Точка входа Flask-приложения
- Определяет все API-маршруты
- Инициализирует `SmetaAIController(app)`
- **Критически важные маршруты**:
  - `/api/ingest` - запуск обработки файлов
  - `/api/optimize` - оптимизация базы знаний
  - `/api/calculate` - расчет новых смет
  - `/api/status` - получение статуса задач
  - `/api/cancel_task` - отмена текущей задачи (с умной обработкой ошибок)
  - `/api/brain/export` - экспорт базы знаний в Excel
  - `/api/brain/import` - импорт базы знаний из Excel
  - `/api/raw_data` - получение сырых данных для UI
  - `/api/clear_data` - очистка баз данных
  - `/api/test_openai` - тест соединения с OpenAI
  - `/api/reset_status` - сброс статуса в idle

#### **`controller.py`** - Оркестратор фоновых задач
- Управляет background threads для длительных операций
- **ИСПРАВЛЕНО**: Реализует надежный механизм отмены задач (`cancellation_token`)
- **НОВОЕ**: Умная фильтрация файлов - обрабатывает только новые/измененные файлы
- Инициализирует `AssistantManager` один раз при старте
- **Ключевые методы**:
  - `_get_new_files_for_processing()` - определяет новые файлы по хешу
  - `cancel_current_task()` - отмена с проверкой и thread, и progress_manager
  - `start_ingest_async()` - запуск обработки только новых файлов
  - `_run_task()` - обработка исключений и отмены

#### **`assistant_manager.py`** - Менеджер OpenAI Assistants API
- **КЛЮЧЕВАЯ ОСОБЕННОСТЬ**: Использует Code Interpreter для обработки Excel
- **ИСПРАВЛЕНО**: Обработка rate limits с автоматическими повторными попытками
- Singleton pattern для Assistant (сохраняет `assistant_id` в файл)
- **Критически важные методы**:
  - `process_file()` - отправка файла в AI с прогрессом и отменой
  - Rate limit handling с экспоненциальной задержкой (до 3 попыток)
  - Сохранение сырых ответов AI в `output/ai_responses/`
  - Использует внешние промпты через `prompt_loader.py`

#### **`ingest.py`** - Обработка входящих файлов
- **ИСПРАВЛЕНО**: Использует правильные методы ProgressManager
- Фильтрация записей без цены (убирает записи где нет ни material_price, ни work_price)
- Проверка метаданных файлов для избежания повторной обработки
- **Ключевые методы**:
  - `process_files()` - основной цикл обработки
  - `_filter_records_with_prices()` - фильтрация записей с ценами
  - `_parse_and_save_ai_response()` - парсинг JSON из ответа AI

#### **`progress_manager.py`** - Управление статусом задач
- **ИСПРАВЛЕНО**: Все методы корректно работают с файлом прогресса
- **Критически важные методы**:
  - `start_task()` - начало отслеживания задачи
  - `update_progress()` - обновление процента и сообщения
  - `complete_task()` - ИСПРАВЛЕНО: корректно завершает задачу
  - `fail_task()` - завершение с ошибкой
  - `is_running()` - проверка активности задачи
- Сохраняет состояние в `ai_progress.json`

#### **`optimize_brain.py`** - Оптимизация базы знаний
- Кластеризация похожих записей через AI
- Использует внешние промпты через `prompt_loader.py`
- Поддерживает отмену через `cancellation_token_getter`

#### **`calculate.py`** - Расчет новых смет
- Семантический поиск совпадений в базе знаний через OpenAI
- Замена старого `BrainSearch` на прямые AI-запросы
- Использует внешние промпты через `prompt_loader.py`

### **Система промптов (prompt_loader.py)**
- **НОВОЕ**: Все AI промпты вынесены в отдельные файлы
- Файлы промптов: `prompt_*.txt`
- Поддержка подстановки переменных через `.format()`
- **Файлы промптов**:
  - `prompt_assistant_instructions.txt` - инструкции для AI Assistant
  - `prompt_file_processing.txt` - сообщение для обработки файла
  - `prompt_calculate_matching.txt` - поиск совпадений в базе
  - `prompt_optimize_clustering.txt` - кластеризация записей
  - `prompt_classify_rows.txt` - классификация строк
  - `prompt_classify_single_row.txt` - классификация одной строки

### **Frontend компоненты**

#### **`templates/index.html`** - Основной интерфейс
- **ИСПРАВЛЕНО**: Кнопка "Остановить" вместо "Обновить"
- Две вкладки: "Полная база" и "База знаний"
- Кнопки экспорта/импорта базы знаний
- Прогресс-бар с автоматическим скрытием

#### **`static/js/app.js`** - Frontend логика
- **ИСПРАВЛЕНО**: Умное управление кнопками
- `cancelCurrentTask()` - функция отмены с подтверждением
- `updateButtonsState()` - показ/скрытие кнопок в зависимости от статуса
- Автоматический сброс прогресс-бара через 5 секунд после завершения

#### **`static/css/style.css`** - Стили
- **ИСПРАВЛЕНО**: Принудительное закругление кнопок toolbar
- Правильное выравнивание кнопок "Обновить" и "Остановить"
- Адаптивные стили для карточек и прогресс-бара

## 4. Поток данных

```
[Excel файлы] → [controller.py] → [ingest.py] → [assistant_manager.py] → [OpenAI API]
                      ↓                                                         ↓
[raw_data.json] ← [Нормализация цен] ← [Парсинг JSON] ← [Code Interpreter результат]
        ↓
[optimize_brain.py] → [AI кластеризация] → [brain.json]
        ↓
[calculate.py] → [AI семантический поиск] → [Расчет новых смет]
```

## 5. Критически важные особенности

### **Обработка только новых файлов**
- Система проверяет хеш файлов в `controller._get_new_files_for_processing()`
- Метаданные сохраняются в `raw_data.json["metadata"]["file_metadata"]`
- Повторная обработка происходит только при изменении файла

### **Rate Limits обработка**
- Автоматическое обнаружение rate limits в `assistant_manager.py`
- До 3 попыток с экспоненциальной задержкой
- Извлечение времени ожидания из сообщения об ошибке

### **Цены за единицу (Unit Prices)**
- Все цены в документах уже указаны за единицу измерения - нормализация не требуется
- **Количество не импортируется** - используется только для расчета общей стоимости в сметах
- **Записи без цены отфильтровываются** в `ingest._filter_records_with_prices()`
- Логика: если `material_price == 0` И `work_price == 0`, то запись исключается из базы
- Критически важно для корректности базы знаний

### **Надежная отмена задач**
- Проверка и через `thread.is_alive()`, и через `progress_manager.is_running()`
- Graceful handling - "Нет активной задачи" не считается ошибкой
- Обновление UI статуса при отмене

## 6. Правила разработки

### **При изменении backend кода**
1. Всегда читать существующий код перед изменениями
2. Проверять имена методов в соответствующих классах
3. Перезапускать сервер после изменений
4. Тестировать через `curl` или браузер

### **При работе с ProgressManager**
- Использовать только существующие методы: `start_task()`, `update_progress()`, `complete_task()`, `fail_task()`
- НЕ использовать несуществующие методы типа `set_status()`

### **При работе с промптами**
- Все новые промпты выносить в файлы `prompt_*.txt`
- Использовать `load_prompt()` из `prompt_loader.py`
- Поддерживать подстановку переменных через `{variable_name}`

### **При работе с UI**
- Тестировать все состояния кнопок (активна/неактивна/скрыта)
- Проверять корректность прогресс-бара
- Убеждаться в правильности стилей

## 7. Отладка и диагностика

### **Основные файлы логов**
- `ai_progress.json` - текущий статус задач
- `ai_optimization_log.json` - история выполнения
- `output/ai_responses/` - сырые ответы от AI

### **Диагностические команды**
```bash
# Проверка статуса
curl -s http://localhost:8000/api/status

# Тест OpenAI соединения  
curl -s http://localhost:8000/api/test_openai

# Сброс статуса
curl -s -X POST http://localhost:8000/api/reset_status

# Отмена задачи
curl -s -X POST http://localhost:8000/api/cancel_task
```

### **Типичные проблемы и решения**
1. **AttributeError с ProgressManager** → проверить имена методов
2. **Повторная обработка файлов** → проверить логику хеширования
3. **Rate limits** → увеличить задержки или уменьшить частоту запросов
4. **Кнопки не активируются** → проверить `is_running` статус

## 8. Развитие системы

### **Текущая стабильная версия включает**
- ✅ Обработка всех типов Excel документов
- ✅ Надежная отмена задач
- ✅ Обработка rate limits
- ✅ Нормализация цен
- ✅ Фильтрация новых файлов
- ✅ Внешние промпты
- ✅ Полнофункциональный UI

### **Потенциальные улучшения**
- Batch обработка файлов для снижения rate limits
- Кэширование результатов AI
- Более детальная аналитика обработки
- Расширенные фильтры в UI базы знаний

---

**ВАЖНО**: Эта версия является стабильной и полностью функциональной. При внесении изменений обязательно тестировать на всех трех документах и обновлять данный гид. 